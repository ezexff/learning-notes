# Compilation

Компиляция C/С++ программы в cmd через MSVC
```
cl main.c
```

Можно указать компилятору несколько .cpp файлов (несколько единиц трансляции). Компилятор объединит содержимое файлов в одно целое, но при этом разные части, принадлежащие main1.cpp и main2.cpp, будут скомпилированы независимо друг от друга. Иными словами, мы можем указать компилятору несколько единиц трансляции (translation units). При компиляции двух единиц трансляции мы можем в одном файле объявить функцию, а в другом иметь реализацию этой функции
```
cl main1.cpp main2.cpp
```

Понятие "единица трансляции" появилось с первыми диалоговыми компьютерами: в те времена нехватка памяти была такой, что компьютер не мог удержать в ней одновременно компилятор, текст крупной программы и результирующий код. Раньше приходилось компилировать по частям, а затем специальной программой (компоновщиком) собирать из откомпилированных модулей исполняемый файл. 

Сейчас текст разбивают на единицы трансляции в первую очередь ради повторного использования кода. Современные оптимизирующие компиляторы зачастую медленны настолько, что пересборка большой программы может длиться десятки минут

Объе́ктный мо́дуль (также --- объектный файл, англ. object file) --- файл с промежуточным представлением отдельного модуля программы, полученный в результате обработки исходного кода компилятором. Объектный файл содержит в себе особым образом подготовленный код (часто называемый двоичным или бинарным), который может быть объединён с другими объектными файлами при помощи редактора связей (компоновщика) для получения готового исполнимого модуля либо библиотеки

Объектные файлы представляют собой блоки машинного кода и данных с неопределенными адресами ссылок на данные и процедуры в других объектных модулях, а также список своих процедур и данных. Компоновщик собирает код и данные каждого объектного модуля в итоговую программу, вычисляет и заполняет адреса перекрестных ссылок между модулями. Связывание со статическими библиотеками выполняется редактором связей или компоновщиком (который может представлять собой отдельную программу или быть частью компилятора), а с операционной системой и динамическими библиотеками связывание выполняется при исполнении программы, после её загрузки в память

Программист генерирует объектный код с помощью компилятора или ассемблера. Например, в Linux компилятор GNU Compiler Collection будет генерировать файлы с расширением .o, которые используют формат ELF. При компиляции в Windows создаются файлы с расширением .obj, использующие формат COFF. Затем компоновщик используется для объединения объектного кода в одну исполняемую программу или библиотеку, при необходимости извлекая предварительно скомпилированные системные библиотеки

При помощи директив препроцесоора, например, можно компилировать часть текста программы только на C
```C
extern "C"
{
    ... // our C only code
}
```

Также можно компилировать функцию только на C. Это позволит компилятору не создавать дополнительный суффикс в имени функции для линкера, необходимый в C++, но не в С, для перегрузки функций
```C
extern "C" int mainCRTStartup(void)
{
    ... // our code
}
```

Посмотреть команды MSVC компилятора
```
cl /?
```

Пример компиляции на Windows C программы через .bat
```bat
@echo off
call "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvarsall.bat" x64
CLS

IF NOT EXIST ..\build mkdir ..\build
pushd ..\build

REM 64-bit build
cl -FC -Zi ..\code\win32_main.cpp user32.lib gdi32.lib
popd
```

/FAsc - параметр компилятора, который позволяет сгенерировать .cod файл с текстом программы на ассемблере

